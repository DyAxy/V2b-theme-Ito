(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[394],{6659:(e,t,r)=>{Promise.resolve().then(r.bind(r,53194))},53194:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>M});var a=r(95155),i=r(12115);let s=i.forwardRef((e,t)=>{let{label:r,value:i,children:s,...l}=e;return(0,a.jsxs)("div",{ref:t,className:"flex items-center justify-between py-1",...l,children:[(0,a.jsx)("div",{className:"text-small text-default-500",children:r}),(0,a.jsx)("div",{className:"text-small  font-semibold text-default-700",children:i||s})]})});s.displayName="CellValue";let l=()=>(0,a.jsxs)("div",{className:"flex flex-row gap-2",children:[(0,a.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce"}),(0,a.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce [animation-delay:-.3s]"}),(0,a.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce [animation-delay:-.5s]"})]});var n=r(59568),o=r(90996);let d={month_price:"月付",quarter_price:"季付",half_year_price:"半年付",year_price:"年付",two_year_price:"两年付",three_year_price:"三年付",onetime_price:"流量包",reset_price:"重置流量",deposit:"充值"},c=e=>e.month_price?"month_price":e.quarter_price?"quarter_price":e.half_year_price?"half_year_price":e.year_price?"year_price":e.two_year_price?"two_year_price":e.three_year_price?"three_year_price":e.onetime_price?"onetime_price":"reset_price",u=["month_price","quarter_price","half_year_price","year_price","two_year_price","three_year_price","onetime_price","reset_price"];var p=r(18850),m=r(10168),h=r(63162),f=r(75243),x=r(22708),g=r(30855),_=r(65701),y=r(15471),b=r(85812),j=r(43350),w=r(77520),v=r(84520),N=r(1493),S=r(54783),A=r(39436),I=r(86613),k=r(66749),C=r(74369),E=r(97376),L=r(17168),O=r(38924),R=r(35695),F=r(56671),P=r(60838);let T=r(39022)({html:!0,linkify:!0,breaks:!0,typographer:!0,listIndent:!0});function M(){var e;let t=(0,R.useRouter)(),{request:r}=(0,n.A)(),M=(0,R.useSearchParams)(),{data:q}=(0,P.Ay)("user/plan/fetch"),{data:z}=(0,P.Ay)("user/order/getPaymentMethod"),[W,B]=(0,i.useState)(),{isOpen:U,onOpen:V,onOpenChange:D,onClose:G}=(0,p.j)(),[H,J]=(0,i.useTransition)(),Y=e=>{B(void 0),X(void 0),V(),J(async()=>{try{let{data:t}=await r.get("user/plan/fetch?id=".concat(e));if(null!==t.data.capacity_limit&&t.data.capacity_limit<=0)throw G(),Error("该订阅已售罄");B(t.data)}catch(e){F.oR.error((0,o.A)(e))}})};(0,i.useEffect)(()=>{let e=M.get("id");if(e){let t=parseInt(e,10);isNaN(t)||Y(t)}},[M]);let[Z,K]=(0,i.useState)("month_price");(0,i.useEffect)(()=>{if(!W)return;let e=M.get("reset"),t=M.get("id");"true"===e&&null!==t&&W.reset_price?K("reset_price"):K(c(W))},[W,M]);let[Q,X]=(0,i.useState)(),[$,ee]=(0,i.useTransition)();(0,i.useEffect)(()=>{if(Q&&Q.limit_period&&!Q.limit_period.includes(Z)){F.oR.error("该优惠码不适用于当前订阅"),X(void 0);return}},[Z,Q]);let[et,er]=(0,i.useState)("");(0,i.useEffect)(()=>{z&&z.data&&(z.data.length>0?er(z.data[0].id.toString()):er(""))},[z]);let ea=(0,i.useMemo)(()=>W&&Z?W[Z]:0,[W,Z]),ei=(0,i.useMemo)(()=>Q&&ea?1===Q.type?ea-Q.value<0?0:ea-Q.value:ea*(1-Q.value/100):0,[Q,ea]),es=(0,i.useMemo)(()=>{if(!et||!z||!ea)return 0;let e=Q?ei:ea,t=0,r=z.data.find(e=>et==e.id.toString());return r&&(r.handling_fee_percent&&(t=e*parseFloat(r.handling_fee_percent)/100),r.handling_fee_fixed&&(t+=parseInt(r.handling_fee_fixed))),t},[Q,ea,ei,et,z]),el=(0,i.useMemo)(()=>Q&&(!Q.limit_period||Q.limit_period.some(e=>e===Z))?ei+es:ea+es,[Q,ea,ei,es,Z]),[en,eo]=(0,i.useTransition)(),ed=e=>{var t,r;return(0,a.jsxs)(m.Z,{fullWidth:!0,radius:"lg",className:"flex flex-col text-left p-4 gap-4 border border-default-200 min-h-[120px] justify-between",shadow:"none",children:[(0,a.jsxs)(h.d,{className:"flex flex-col gap-2 items-start",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center w-full",children:[(0,a.jsx)("span",{className:"font-bold text-xl truncate",children:e.name}),null!=e.capacity_limit&&e.capacity_limit<=10&&(0,a.jsx)(f.R,{color:e.capacity_limit>0?"warning":"danger",variant:"flat",size:"sm",children:e.capacity_limit>0?"仅剩 "+e.capacity_limit+" 份":"售罄"})]}),(0,a.jsxs)("span",{className:"text-base/7 text-default-500",children:["包含"," ",(0,a.jsxs)("span",{className:"font-bold text-primary",children:[e.transfer_enable," GB"]})," ","流量"]}),(0,a.jsxs)("p",{className:"flex items-baseline gap-x-2 text-default-900",children:[(0,a.jsx)("span",{className:"text-5xl font-semibold tracking-tight",children:e[c(e)]?"\xa5 "+((null!=(t=e[c(e)])?t:0)/100).toFixed(2):"免费"}),(0,a.jsxs)("span",{className:"text-base",children:["/ ",d[c(e)]]})]})]}),(0,a.jsx)(x.U,{children:(r=e.content)?(()=>{try{let e=JSON.parse(r);if(Array.isArray(e))return!0;return!1}catch(e){return!1}})()?(0,a.jsx)("ul",{className:"flex flex-col gap-2",children:JSON.parse(r).map((e,t)=>(0,a.jsxs)("li",{className:"flex items-center gap-2",children:[e.support?(0,a.jsx)(L.A,{className:"text-primary min-w-[24px]",width:24}):(0,a.jsx)(O.A,{className:"text-danger min-w-[24px]",width:24}),(0,a.jsx)("p",{className:"text-default-500",children:e.feature})]},t))}):/<\/?[a-z][\s\S]*>/i.test(r)?(0,a.jsx)("div",{className:"text-sm text-default-700 html-content",dangerouslySetInnerHTML:{__html:T.render(r)}}):(0,a.jsx)("div",{children:r.split("\n").map((e,t)=>e?(0,a.jsx)("p",{children:e},t):(0,a.jsx)("br",{},t))}):null}),(0,a.jsx)(g.Z,{children:(0,a.jsx)(_.T,{color:"primary",className:"mt-4 p-4",fullWidth:!0,isDisabled:!(null===e.capacity_limit||e.capacity_limit>0)||H,onPress:()=>Y(e.id),children:"前往购买"})})]},e.id)};return(0,a.jsxs)("div",{className:"flex flex-col w-full gap-6 sm:gap-12 items-center justify-center",children:[(0,a.jsxs)(y.r,{"aria-label":"Options",variant:"underlined",size:"lg",classNames:{panel:"p-0 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 w-full"},children:[(0,a.jsx)(b.i,{title:"全部订阅",children:q&&q.data?q.data.map(ed):null},"all"),(0,a.jsx)(b.i,{title:"循环订阅",children:q&&q.data&&q.data.map(e=>{if("onetime_price"!==c(e))return ed(e)})},"period"),(0,a.jsx)(b.i,{title:"流量包订阅",children:q&&q.data&&q.data.map(e=>{if("onetime_price"===c(e))return ed(e)})},"one-time")]}),(0,a.jsx)(j.Y,{isOpen:U,onOpenChange:D,radius:"lg",hideCloseButton:!0,scrollBehavior:"inside",children:(0,a.jsx)(w.g,{children:W?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(v.c,{children:["套餐详情：",W.name]}),(0,a.jsxs)(N.h,{children:[(0,a.jsx)(s,{label:"套餐流量",value:W.transfer_enable+" GB"}),(0,a.jsx)(S.U,{label:"选择周期",value:Z,onValueChange:K,className:"text-sm",classNames:{wrapper:"grid grid-cols-3 gap-4"},children:"reset_price"===Z?(0,a.jsx)(A.O,{value:"reset_price",description:"\xa5 "+((null!=(e=W.reset_price)?e:0)/100).toFixed(2),classNames:{wrapper:"hidden",label:"text-sm",base:(0,I.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:d.reset_price},"reset_price"):u.filter(e=>null!==W[e]).map(e=>{var t;return"reset_price"===e?null:(0,a.jsx)(A.O,{value:e,description:"\xa5 "+((null!=(t=W[e])?t:0)/100).toFixed(2),classNames:{wrapper:"hidden",label:"text-sm",base:(0,I.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:d[e]},e)})}),(0,a.jsx)(S.U,{label:"支付方式",value:et,onValueChange:er,className:"text-sm",children:z&&z.data&&z.data.map(e=>(0,a.jsx)(A.O,{value:e.id.toString(),classNames:{label:"text-sm",base:(0,I.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","flex-row-reverse min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:e.name},e.id))}),(0,a.jsxs)(k.l,{className:"flex flex-row items-end gap-2",onSubmit:e=>{e.preventDefault();let t=Object.fromEntries(new FormData(e.currentTarget));ee(async()=>{if(t.coupon)try{let e=await r.post("user/coupon/check",{code:t.coupon,plan_id:W.id}),a=e.data.data;if(a.limit_period&&!a.limit_period.includes(Z))throw Error("优惠码不适用于当前周期");X(e.data.data),F.oR.success("优惠码验证成功")}catch(e){X(void 0),F.oR.error((0,o.A)(e))}})},children:[(0,a.jsx)(C.r,{name:"coupon",fullWidth:!0,size:"sm",variant:"bordered",label:"优惠码",labelPlacement:"outside",placeholder:"如果有优惠码可以在此输入",radius:"md",classNames:{input:"text-xs",inputWrapper:"group-data-[focus=true]:border-primary data-[hover=true]:border-primary",label:"group-data-[filled-within=true]:text-default-500 text-sm",helperWrapper:"h-4"}}),(0,a.jsx)(_.T,{radius:"md",color:"primary",variant:"flat",size:"sm",type:"submit",isLoading:$,children:!$&&"验证"})]}),ei>0&&(0,a.jsx)(s,{label:"优惠金额",value:"- \xa5 "+((ea-ei)/100).toFixed(2)}),es>0&&(0,a.jsx)(s,{label:"手续费",value:"\xa5 "+(es/100).toFixed(2)}),(0,a.jsx)(s,{label:"支付总计",value:"\xa5 "+(el/100).toFixed(2)})]}),(0,a.jsx)(E.q,{children:(0,a.jsxs)(_.T,{fullWidth:!0,radius:"md",color:"primary",onPress:()=>{eo(async()=>{if(et&&Z&&W)try{let{data:{data:e}}=await r.get("user/order/fetch");if(e.length>0){let t=e[0];0===t.status&&await r.post("user/order/cancel",{trade_no:t.trade_no})}let{data:{data:a}}=await r.post("user/order/save",{plan_id:W.id,period:Z,coupon_code:null==Q?void 0:Q.code}),{data:{data:i}}=await r.post("user/order/checkout",{trade_no:a,method:et});!0===i?(F.oR.success("本次订单无需支付，已成功续费"),t.push("/profile")):t.push(i)}catch(e){F.oR.error((0,o.A)(e))}})},isLoading:en,children:["确认支付 \xa5",(el/100).toFixed(2)]})})]}):(0,a.jsx)("div",{className:"flex flex-col items-center justify-center gap-4 p-8",children:(0,a.jsx)(l,{})})})})]})}},59568:(e,t,r)=>{"use strict";r.d(t,{A:()=>c,O:()=>d});var a=r(95155),i=r(23464),s=r(12115),l=r(60838),n=r(792);let o=(0,s.createContext)(void 0),d=e=>{let{children:t}=e,[r,d]=(0,s.useState)(()=>{let e=localStorage.getItem("auth_data");return{isAuthChecked:!!e,isLoggedIn:!!e}}),[c,u]=(0,s.useState)(),[p,m]=(0,s.useState)();(0,s.useEffect)(()=>{if(!window.settings)return;let{title:e,description:t}=window.settings;document.title="".concat(e," - ").concat(t),window.settings.crisp_id&&n.YH.configure(window.settings.crisp_id),u(window.settings)},[]);let h=(0,s.useMemo)(()=>{if(!c)return;let{api:e}=c,t=i.A.create({baseURL:new URL("/api/v1",e).toString(),timeout:1e4,headers:{"Content-Type":"application/json"}});return t.interceptors.request.use(e=>{let t=localStorage.getItem("auth_data");return t&&(e.headers.Authorization=t),e}),t.interceptors.response.use(e=>e,e=>{var t;return(null==(t=e.response)?void 0:t.status)===403&&(localStorage.removeItem("auth_data"),d(e=>({...e,isLoggedIn:!1}))),Promise.reject(e)}),d(e=>({...e,isAuthChecked:!0})),t},[c]),f=(0,s.useCallback)(async e=>{if(!h)return;let{data:t}=await h.get(e);return t},[h]);(0,s.useEffect)(()=>{h&&localStorage.getItem("auth_data")&&(async()=>{try{await h.get("user/checkLogin"),d(e=>({...e,isLoggedIn:!0}))}catch(e){console.error("Failed to check session:",e)}})()},[h]);let x=(0,s.useCallback)(async()=>{if(h&&!p)try{let e=await h.get("guest/comm/config");m(e.data.data)}catch(e){console.error("Failed to load remote config:",e)}},[h,p]),g=async(e,t)=>{if(h)try{let{data:r}=await h.post("passport/auth/login",{email:e,password:t});localStorage.setItem("auth_data",r.data.auth_data),d(e=>({...e,isLoggedIn:!0}))}catch(e){throw e}},_=async(e,t,r,a)=>{if(h)try{let{data:i}=await h.post("passport/auth/register",{email:e,password:t,email_code:r,invite_code:a});localStorage.setItem("auth_data",i.data.auth_data),d(e=>({...e,isLoggedIn:!0}))}catch(e){throw e}},y=async(e,t,r)=>{if(h)try{await h.post("passport/auth/forget",{email:e,password:t,email_code:r})}catch(e){throw e}},b=async e=>{if(h)try{await h.post("passport/comm/sendEmailVerify",{email:e})}catch(e){throw e}};return(0,a.jsx)(o.Provider,{value:{isAuthChecked:r.isAuthChecked,isLoggedIn:r.isLoggedIn,request:h,config:c,remoteConfig:p,loadRemoteConfig:x,signIn:g,signUp:_,signOut:()=>{localStorage.removeItem("auth_data"),d({isAuthChecked:!0,isLoggedIn:!1})},sendVerifyCode:b,resetPassword:y},children:(0,a.jsx)(l.BE,{value:{fetcher:f,errorRetryCount:1,errorRetryInterval:100},children:t})})},c=()=>{let e=(0,s.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},90996:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var a=r(23464);let i=e=>{if(a.A.isAxiosError(e))if(!e.response)return"网络错误，请尝试更换浏览器或者网络环境后再试";else{var t;let r=null==(t=e.response)?void 0:t.data;if(r.message)return r.message}return e instanceof Error?e.message:"未知错误"}}},e=>{e.O(0,[825,84,876,895,330,671,829,215,234,369,479,76,183,326,638,441,964,358],()=>e(e.s=6659)),_N_E=e.O()}]);
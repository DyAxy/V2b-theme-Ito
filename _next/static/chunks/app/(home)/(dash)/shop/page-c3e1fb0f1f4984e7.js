(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[394],{6659:(e,t,a)=>{Promise.resolve().then(a.bind(a,53194))},53194:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>P});var r=a(95155),i=a(12115);let s=i.forwardRef((e,t)=>{let{label:a,value:i,children:s,...l}=e;return(0,r.jsxs)("div",{ref:t,className:"flex items-center justify-between py-1",...l,children:[(0,r.jsx)("div",{className:"text-small text-default-500",children:a}),(0,r.jsx)("div",{className:"text-small  font-semibold text-default-700",children:i||s})]})});s.displayName="CellValue";let l=()=>(0,r.jsxs)("div",{className:"flex flex-row gap-2",children:[(0,r.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce"}),(0,r.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce [animation-delay:-.3s]"}),(0,r.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce [animation-delay:-.5s]"})]});var n=a(59568),o=a(90996);let d={month_price:"月付",quarter_price:"季付",half_year_price:"半年付",year_price:"年付",two_year_price:"两年付",three_year_price:"三年付",onetime_price:"流量包",reset_price:"重置流量",deposit:"充值"},c=e=>e.month_price?"month_price":e.quarter_price?"quarter_price":e.half_year_price?"half_year_price":e.year_price?"year_price":e.two_year_price?"two_year_price":e.three_year_price?"three_year_price":e.onetime_price?"onetime_price":"reset_price",u=["month_price","quarter_price","half_year_price","year_price","two_year_price","three_year_price","onetime_price","reset_price"];var p=a(18850),m=a(10168),h=a(63162),f=a(75243),x=a(22708),_=a(30855),g=a(65701),y=a(15471),b=a(85812),w=a(43350),j=a(77520),v=a(84520),N=a(1493),S=a(54783),I=a(39436),A=a(86613),k=a(66749),C=a(74369),E=a(97376),L=a(35695),F=a(56671),R=a(60838);let O=a(39022)({html:!0,linkify:!0,breaks:!0,typographer:!0,listIndent:!0});function P(){let e=(0,L.useRouter)(),{request:t}=(0,n.A)(),a=(0,L.useSearchParams)(),{data:P}=(0,R.Ay)("user/plan/fetch"),{data:T}=(0,R.Ay)("user/order/getPaymentMethod"),[q,z]=(0,i.useState)(),{isOpen:B,onOpen:U,onOpenChange:W}=(0,p.j)(),[V,D]=(0,i.useTransition)(),M=e=>{z(void 0),U(),D(async()=>{try{let{data:a}=await t.get("user/plan/fetch?id=".concat(e));if(null!==a.data.capacity_limit&&a.data.capacity_limit<=0)throw Error("该订阅已售罄");z(a.data)}catch(e){F.oR.error((0,o.A)(e))}})};(0,i.useEffect)(()=>{let e=a.get("id");if(e){let t=parseInt(e,10);isNaN(t)||M(t)}},[a]);let[G,H]=(0,i.useState)("month_price");(0,i.useEffect)(()=>{if(!q)return;let e=a.get("reset"),t=a.get("id");"true"===e&&null!==t&&q.reset_price?H("reset_price"):H(c(q))},[q,a]);let[Y,Z]=(0,i.useState)(),[J,K]=(0,i.useTransition)();(0,i.useEffect)(()=>{if(Y&&Y.limit_period&&!Y.limit_period.includes(G)){F.oR.error("该优惠码不适用于当前订阅"),Z(void 0);return}},[G,Y]);let[Q,X]=(0,i.useState)("");(0,i.useEffect)(()=>{T&&T.data&&(T.data.length>0?X(T.data[0].id.toString()):X(""))},[T]);let $=()=>q&&G?q[G]:0,ee=()=>Y&&$()?1===Y.type?$()-Y.value<0?0:$()-Y.value:$()*(1-Y.value/100):0,et=()=>{let e=Y?ee():$();if(!e||!Q||!T)return 0;let t=0,a=T.data.find(e=>Q==e.id.toString());return a&&(a.handling_fee_percent&&(t=e*parseFloat(a.handling_fee_percent)/100),a.handling_fee_fixed&&(t+=parseInt(a.handling_fee_fixed))),t},[ea,er]=(0,i.useTransition)(),ei=e=>{var t;return(0,r.jsxs)(m.Z,{fullWidth:!0,radius:"lg",className:"flex flex-col text-left p-4 gap-4 border border-default-200 min-h-[120px] justify-between",shadow:"none",children:[(0,r.jsxs)(h.d,{className:"flex flex-col gap-2 items-start",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center w-full",children:[(0,r.jsx)("span",{className:"font-bold text-xl truncate",children:e.name}),null!=e.capacity_limit&&e.capacity_limit<=10&&(0,r.jsx)(f.R,{color:e.capacity_limit>0?"warning":"danger",variant:"flat",size:"sm",children:e.capacity_limit>0?"仅剩 "+e.capacity_limit+" 份":"售罄"})]}),(0,r.jsxs)("span",{className:"text-base/7 text-default-500",children:["包含"," ",(0,r.jsxs)("span",{className:"font-bold text-primary",children:[e.transfer_enable," GB"]})," ","流量"]}),(0,r.jsxs)("p",{className:"flex items-baseline gap-x-2 text-default-900",children:[(0,r.jsx)("span",{className:"text-5xl font-semibold tracking-tight",children:e[c(e)]?"\xa5 "+((null!=(t=e[c(e)])?t:0)/100).toFixed(2):"免费"}),(0,r.jsxs)("span",{className:"text-base",children:["/ ",d[c(e)]]})]})]}),(0,r.jsx)(x.U,{className:"html-content text-sm text-default-700",dangerouslySetInnerHTML:{__html:O.render(e.content)}}),(0,r.jsx)(_.Z,{children:(0,r.jsx)(g.T,{color:"primary",className:"mt-4 p-4",fullWidth:!0,isDisabled:!(null===e.capacity_limit||e.capacity_limit>0)||V,onPress:()=>M(e.id),children:"前往购买"})})]},e.id)};return P&&P.data?(0,r.jsxs)("div",{className:"flex flex-col w-full gap-6 sm:gap-12 items-center justify-center",children:[(0,r.jsxs)(y.r,{"aria-label":"Options",variant:"underlined",size:"lg",classNames:{panel:"p-0 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 w-full"},children:[(0,r.jsx)(b.i,{title:"全部订阅",children:P.data.map(ei)},"all"),(0,r.jsx)(b.i,{title:"循环订阅",children:P.data.map(e=>{if("onetime_price"!==c(e))return ei(e)})},"period"),(0,r.jsx)(b.i,{title:"流量包订阅",children:P.data.map(e=>{if("onetime_price"===c(e))return ei(e)})},"one-time")]}),(0,r.jsx)(w.Y,{isOpen:B,onOpenChange:W,radius:"lg",hideCloseButton:!0,scrollBehavior:"inside",children:(0,r.jsx)(j.g,{children:q?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(v.c,{children:["套餐详情：",q.name]}),(0,r.jsxs)(N.h,{children:[(0,r.jsx)(s,{label:"套餐流量",value:q.transfer_enable+" GB"}),(0,r.jsx)(S.U,{label:"选择周期",value:G,onValueChange:H,className:"text-sm",classNames:{wrapper:"grid grid-cols-3 gap-4"},children:"reset_price"===G?(0,r.jsx)(I.O,{value:"reset_price",classNames:{wrapper:"hidden",label:"text-sm",base:(0,A.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","min-w-full cursor-pointer rounded-medium5 p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:d.reset_price},"reset_price"):u.filter(e=>null!==q[e]).map(e=>{var t;return"reset_price"===e?null:(0,r.jsx)(I.O,{value:e,description:"\xa5 "+((null!=(t=q[e])?t:0)/100).toFixed(2),classNames:{wrapper:"hidden",label:"text-sm",base:(0,A.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:d[e]},e)})}),(0,r.jsx)(S.U,{label:"支付方式",value:Q,onValueChange:X,className:"text-sm",children:T&&T.data&&T.data.map(e=>(0,r.jsx)(I.O,{value:e.id.toString(),classNames:{label:"text-sm",base:(0,A.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","flex-row-reverse min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:e.name},e.id))}),(0,r.jsxs)(k.l,{className:"flex flex-row items-end gap-2",onSubmit:e=>{e.preventDefault();let a=Object.fromEntries(new FormData(e.currentTarget));K(async()=>{if(a.coupon)try{let e=await t.post("user/coupon/check",{code:a.coupon,plan_id:q.id}),r=e.data.data;if(r.limit_period&&!r.limit_period.includes(G))throw Error("优惠码不适用于当前周期");Z(e.data.data),F.oR.success("优惠码验证成功")}catch(e){Z(void 0),F.oR.error((0,o.A)(e))}})},children:[(0,r.jsx)(C.r,{name:"coupon",fullWidth:!0,size:"sm",variant:"bordered",label:"优惠码",labelPlacement:"outside",placeholder:"如果有优惠码可以在此输入",radius:"md",classNames:{input:"text-xs",label:"group-data-[filled-within=true]:text-default-500 text-sm",helperWrapper:"h-4"}}),(0,r.jsx)(g.T,{radius:"md",color:"primary",variant:"flat",size:"sm",type:"submit",isLoading:J,children:!J&&"验证"})]}),(0,r.jsx)(s,{label:"套餐金额",value:"\xa5 "+($()/100).toFixed(2)}),ee()>0&&(0,r.jsx)(s,{label:"优惠金额",value:"- \xa5 "+(($()-ee())/100).toFixed(2)}),et()>0&&(0,r.jsx)(s,{label:"支付手续费",value:"\xa5 "+(et()/100).toFixed(2)}),(0,r.jsx)(s,{label:"支付总计",value:"\xa5 "+(Y&&(!Y.limit_period||Y.limit_period.some(e=>e===G))?((ee()+et())/100).toFixed(2):(($()+et())/100).toFixed(2))})]}),(0,r.jsx)(E.q,{children:(0,r.jsx)(g.T,{fullWidth:!0,radius:"md",color:"primary",onPress:()=>{er(async()=>{if(Q&&G&&q)try{let{data:{data:a}}=await t.get("user/order/fetch");if(a.length>0){let e=a[0];0===e.status&&await t.post("user/order/cancel",{trade_no:e.trade_no})}let{data:{data:r}}=await t.post("user/order/save",{plan_id:q.id,period:G,coupon_code:null==Y?void 0:Y.code}),{data:{data:i}}=await t.post("user/order/checkout",{trade_no:r,method:Q});e.push(i)}catch(e){F.oR.error((0,o.A)(e))}})},isLoading:ea,children:"确认支付"})})]}):(0,r.jsx)("div",{className:"flex flex-col items-center justify-center gap-4 p-8",children:(0,r.jsx)(l,{})})})})]}):null}},59568:(e,t,a)=>{"use strict";a.d(t,{A:()=>c,O:()=>d});var r=a(95155),i=a(23464),s=a(12115),l=a(60838),n=a(792);let o=(0,s.createContext)(void 0),d=e=>{let{children:t}=e,[a,d]=(0,s.useState)(()=>{let e=localStorage.getItem("auth_data");return{isAuthChecked:!!e,isLoggedIn:!!e}}),[c,u]=(0,s.useState)(),[p,m]=(0,s.useState)();(0,s.useEffect)(()=>{if(!window.settings)return;let{title:e,description:t}=window.settings;document.title="".concat(e," - ").concat(t),window.settings.crisp_id&&n.YH.configure(window.settings.crisp_id),u(window.settings)},[]);let h=(0,s.useMemo)(()=>{if(!c)return;let{api:e}=c,t=i.A.create({baseURL:new URL("/api/v1",e).toString(),timeout:1e4,headers:{"Content-Type":"application/json"}});return t.interceptors.request.use(e=>{let t=localStorage.getItem("auth_data");return t&&(e.headers.Authorization=t),e}),t.interceptors.response.use(e=>e,e=>{var t;return(null==(t=e.response)?void 0:t.status)===403&&(localStorage.removeItem("auth_data"),d(e=>({...e,isLoggedIn:!1}))),Promise.reject(e)}),d(e=>({...e,isAuthChecked:!0})),t},[c]),f=(0,s.useCallback)(async e=>{if(!h)return;let{data:t}=await h.get(e);return t},[h]);(0,s.useEffect)(()=>{h&&localStorage.getItem("auth_data")&&(async()=>{try{await h.get("user/checkLogin"),d(e=>({...e,isLoggedIn:!0}))}catch(e){console.error("Failed to check session:",e)}})()},[h]);let x=(0,s.useCallback)(async()=>{if(h&&!p)try{let e=await h.get("guest/comm/config");m(e.data.data)}catch(e){console.error("Failed to load remote config:",e)}},[h,p]),_=async(e,t)=>{if(h)try{let{data:a}=await h.post("passport/auth/login",{email:e,password:t});localStorage.setItem("auth_data",a.data.auth_data),d(e=>({...e,isLoggedIn:!0}))}catch(e){throw e}},g=async(e,t,a,r)=>{if(h)try{let{data:i}=await h.post("passport/auth/register",{email:e,password:t,email_code:a,invite_code:r});localStorage.setItem("auth_data",i.data.auth_data),d(e=>({...e,isLoggedIn:!0}))}catch(e){throw e}},y=async(e,t,a)=>{if(h)try{await h.post("passport/auth/forget",{email:e,password:t,email_code:a})}catch(e){throw e}},b=async e=>{if(h)try{await h.post("passport/comm/sendEmailVerify",{email:e})}catch(e){throw e}};return(0,r.jsx)(o.Provider,{value:{isAuthChecked:a.isAuthChecked,isLoggedIn:a.isLoggedIn,request:h,config:c,remoteConfig:p,loadRemoteConfig:x,signIn:_,signUp:g,signOut:()=>{localStorage.removeItem("auth_data"),d({isAuthChecked:!0,isLoggedIn:!1})},sendVerifyCode:b,resetPassword:y},children:(0,r.jsx)(l.BE,{value:{fetcher:f,errorRetryCount:1,errorRetryInterval:100},children:t})})},c=()=>{let e=(0,s.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},90996:(e,t,a)=>{"use strict";a.d(t,{A:()=>i});var r=a(23464);let i=e=>{if(r.A.isAxiosError(e))if(!e.response)return"网络错误，请尝试更换浏览器或者网络环境后再试";else{var t;let a=null==(t=e.response)?void 0:t.data;if(a.message)return a.message}return e instanceof Error?e.message:"未知错误"}}},e=>{e.O(0,[825,84,876,895,979,671,829,215,369,318,572,710,152,441,964,358],()=>e(e.s=6659)),_N_E=e.O()}]);